name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  actions: read  # Required to check Quality Assurance workflow status

jobs:
  release:
    name: Create Release with Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Wait for Quality Assurance workflow
        run: |
          set -euo pipefail

          echo "ğŸ” Waiting for Quality Assurance workflow to complete for commit ${{ github.sha }}"
          echo "âš ï¸  This prevents releases until all blocking security checks pass"

          # Maximum wait time: 15 minutes
          max_wait=900
          wait_time=0
          check_interval=30

          while [ $wait_time -lt $max_wait ]; do
            # Get all workflow runs for this commit
            runs=$(gh api repos/${{ github.repository }}/actions/runs \
              --jq ".workflow_runs[] | select(.head_sha == \"${{ github.sha }}\" and .name == \"Quality Assurance\")")

            if [ -z "$runs" ]; then
              echo "â³ No Quality Assurance workflow found yet, waiting ${check_interval}s..."
              sleep $check_interval
              wait_time=$((wait_time + check_interval))
              continue
            fi

            # Get the status and conclusion of the Quality Assurance workflow
            status=$(echo "$runs" | jq -r '.status' | head -1)
            conclusion=$(echo "$runs" | jq -r '.conclusion' | head -1)

            echo "ğŸ“‹ Quality Assurance workflow status: $status, conclusion: $conclusion"

            if [ "$status" = "completed" ]; then
              if [ "$conclusion" = "success" ]; then
                echo "âœ… Quality Assurance workflow completed successfully"
                echo "ğŸš€ Proceeding with release creation"
                break
              else
                echo "âŒ Quality Assurance workflow failed with conclusion: $conclusion"
                echo "ğŸš« Blocking release creation due to security check failures"
                exit 1
              fi
            else
              echo "â³ Quality Assurance workflow still running ($status), waiting ${check_interval}s..."
              sleep $check_interval
              wait_time=$((wait_time + check_interval))
            fi
          done

          if [ $wait_time -ge $max_wait ]; then
            echo "â° Timeout waiting for Quality Assurance workflow"
            echo "ğŸš« Blocking release creation due to timeout"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Validate tag format
        run: |
          if [[ ! "${{ github.ref_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid tag format. Expected: v1.2.3"
            exit 1
          fi
          echo "âœ… Valid semver tag: ${{ github.ref_name }}"

      - name: Generate release artifacts
        run: |
          set -euo pipefail

          # Generate checksums for installer scripts
          sha256sum install-security-controls.sh > install-security-controls.sh.sha256
          sha256sum uninstall-security-controls.sh > uninstall-security-controls.sh.sha256

          # Create combined checksums file
          cat > checksums.txt <<EOF
          # 1-Click GitHub Security ${{ github.ref_name }} - Release Checksums
          # Verify with: sha256sum -c checksums.txt

          EOF
          cat install-security-controls.sh.sha256 >> checksums.txt
          cat uninstall-security-controls.sh.sha256 >> checksums.txt

          # Display checksums for verification
          echo "ğŸ“‹ Generated checksums:"
          cat checksums.txt

      - name: Validate installer integrity
        run: |
          set -euo pipefail

          # Quick syntax check
          bash -n install-security-controls.sh
          bash -n uninstall-security-controls.sh

          # Verify checksums
          sha256sum -c install-security-controls.sh.sha256
          sha256sum -c uninstall-security-controls.sh.sha256

          echo "âœ… All integrity checks passed"

      - name: Create Release
        uses: softprops/action-gh-release@a74c6b72af54cfa997e81df42d94703d6313a2d0 # v2.0.6
        with:
          files: |
            install-security-controls.sh
            install-security-controls.sh.sha256
            uninstall-security-controls.sh
            uninstall-security-controls.sh.sha256
            checksums.txt
          generate_release_notes: true
          name: "1-Click GitHub Security ${{ github.ref_name }}"
          body: |
            ## ğŸ›¡ï¸ 1-Click GitHub Security ${{ github.ref_name }}

            ### ğŸ“¦ Quick Installation

            ```bash
            # Download and verify installer
            curl -O https://github.com/h4x0r/1-click-github-sec/releases/download/${{ github.ref_name }}/install-security-controls.sh
            curl -O https://github.com/h4x0r/1-click-github-sec/releases/download/${{ github.ref_name }}/install-security-controls.sh.sha256

            # Verify checksum (REQUIRED for security)
            sha256sum -c install-security-controls.sh.sha256

            # Install security controls
            chmod +x install-security-controls.sh
            ./install-security-controls.sh
            ```

            ### ğŸ” Security Verification

            - âœ… All release artifacts include SHA256 checksums
            - âœ… Scripts validated for syntax and integrity
            - âœ… Generated from signed commits

            ### ğŸ“‹ Release Artifacts

            | File | Purpose | Verification |
            |------|---------|--------------|
            | `install-security-controls.sh` | Main installer script with 4-mode signing support | Required checksum verification |
            | `install-security-controls.sh.sha256` | SHA256 checksum | Use with `sha256sum -c` |
            | `uninstall-security-controls.sh` | Removal script | Optional but recommended |
            | `uninstall-security-controls.sh.sha256` | SHA256 checksum | Use with `sha256sum -c` |
            | `checksums.txt` | Combined checksums | All files in one place |

            ### ğŸ“š Documentation

            **[Complete Documentation â†’](https://h4x0r.github.io/1-click-github-sec/)**

            ---

            **ğŸ›¡ï¸ Always verify checksums before execution - this is critical for security!**
          draft: false
          prerelease: false

      - name: Update installation instructions in README
        run: |
          echo "ğŸ”„ README update suggestions:"
          echo "Consider updating README.md Quick Start section to reference this release:"
          echo "  curl -O https://github.com/h4x0r/1-click-github-sec/releases/download/${{ github.ref_name }}/install-security-controls.sh"
          echo "  curl -O https://github.com/h4x0r/1-click-github-sec/releases/download/${{ github.ref_name }}/install-security-controls.sh.sha256"